name: Commit log

on:
  push:
    branches:
      - main

jobs:
  save-commits:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build commit log (Markdown)
        run: |
          # Détecte la plage de commits fournie par l'événement push
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            RANGE="${{ github.sha }}"
          else
            RANGE="${{ github.event.before }}..${{ github.sha }}"
          fi

          outfile="commit-log-${{ github.sha }}.md"
          echo "# Commit log for $GITHUB_REF ($RANGE)" > "$outfile"
          echo "" >> "$outfile"

          # Build log without exposing emails
          git log "$RANGE" --pretty=format:'### %H%n- Author: %an%n- Date: %aI%n- Title: %s%n%n%b%n' >> "$outfile" || true

          echo "Wrote $outfile"
          ls -l "$outfile"

      - name: Send commit log via email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "GitHub Commit Log: ${{ github.repository }} - ${{ github.ref_name }}"
          to: ${{ secrets.RECIPIENT_EMAIL }}
          from: "GitHub Actions <${{ secrets.MAIL_USERNAME }}>"
          body: "Please find the attached commit log for the recent push to ${{ github.ref_name }}."
          attachments: "commit-log-${{ github.sha }}.md"
