# .github/workflows/commit-lines.yml
name: Commit line stats

on:
  push:
    branches:
      - main    # adapte selon tes branches

jobs:
  compute-lines:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # important pour pouvoir comparer au commit précédent

      - name: Compute added/deleted lines for this commit
        run: |
          # On récupère le SHA du commit courant
          COMMIT_SHA=${{ github.sha }}

          # Si c'est le premier commit, il n'a pas de parent, donc on traite un cas spécial
          PARENT_SHA=$(git rev-parse ${COMMIT_SHA}^ || echo "")

          if [ -z "$PARENT_SHA" ]; then
            # Premier commit : diff par rapport à un arbre vide
            DIFF_RANGE=${COMMIT_SHA}
          else
            # Commit normal : diff par rapport au parent direct
            DIFF_RANGE=${PARENT_SHA}..${COMMIT_SHA}
          fi

          # On utilise git diff pour obtenir le nombre total de lignes ajoutées/supprimées
          # --shortstat donne un résumé, qu'on parse ensuite
          STATS_LINE=$(git diff --shortstat $DIFF_RANGE || echo "")

          # Exemple de STATS_LINE :
          # " 3 files changed, 54 insertions(+), 10 deletions(-)"
          # On extrait les nombres (si pas de match, on retourne 0)
          ADDED=$(echo "$STATS_LINE" | sed -n 's/.*, \([0-9]\+\) insertions*(+).*/\1/p')
          DELETED=$(echo "$STATS_LINE" | sed -n 's/.*, \([0-9]\+\) deletions*(-).*/\1/p')

          if [ -z "$ADDED" ]; then ADDED=0; fi
          if [ -z "$DELETED" ]; then DELETED=0; fi

          echo "Commit: $COMMIT_SHA"
          echo "Lignes ajoutées: $ADDED"
          echo "Lignes supprimées: $DELETED"

          # On crée un petit JSON avec les stats
          cat <<EOF > commit-lines-stats.json
          {
            "commit": "$COMMIT_SHA",
            "added": $ADDED,
            "deleted": $DELETED
          }
          EOF

      - name: Upload stats as artifact
        uses: actions/upload-artifact@v4
        with:
          name: commit-lines-${{ github.sha }}
          path: commit-lines-stats.json
