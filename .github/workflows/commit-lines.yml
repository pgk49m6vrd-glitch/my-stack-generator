# .github/workflows/commit-lines.yml
name: Commit line stats

on:
  push:
    branches:
      - main    # adapte selon tes branches

jobs:
  compute-lines:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute added/deleted lines for this commit
        run: |
          COMMIT_SHA=${{ github.sha }}
          # Detect the commit range
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            DIFF_RANGE="${COMMIT_SHA}"
          else
            DIFF_RANGE="${{ github.event.before }}..${COMMIT_SHA}"
          fi

          # Use git diff --numstat for reliable parsing
          # numstat output format: added \t deleted \t filename
          STATS=$(git diff --numstat $DIFF_RANGE || echo "")

          ADDED=$(echo "$STATS" | awk '{sum+=$1} END {print sum+0}')
          DELETED=$(echo "$STATS" | awk '{sum+=$2} END {print sum+0}')

          if [ -z "$ADDED" ]; then ADDED=0; fi
          if [ -z "$DELETED" ]; then DELETED=0; fi

          echo "Commit: $COMMIT_SHA"
          echo "Lignes ajoutées: $ADDED"
          echo "Lignes supprimées: $DELETED"

          # On crée un petit JSON avec les stats
          cat <<EOF > commit-lines-stats.json
          {
            "commit": "$COMMIT_SHA",
            "added": $ADDED,
            "deleted": $DELETED
          }
          EOF

      - name: Upload stats as artifact
        uses: actions/upload-artifact@v4
        with:
          name: commit-lines-${{ github.sha }}
          path: commit-lines-stats.json
